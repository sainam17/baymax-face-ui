<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BayMax Robot Face</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    /* ===== EYE SOCKET — rounded rectangle (capsule) container ===== */
    .eye-socket {
      position: relative;
      width: 200px;
      height: 300px;
      border-radius: 100px;
      overflow: hidden;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 0 30px rgba(100, 140, 255, 0.06);
      transition: transform 0.3s ease;
    }

    /* ===== EYEBALL — fills the socket, solid black ===== */
    .eyeball {
      position: absolute;
      inset: 0;
      border-radius: 100px;
      background: #000000;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* ===== IRIS — capsule shape matching eyeball ===== */
    .iris {
      position: absolute;
      width: 55%;
      height: 55%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 100px;
      background: radial-gradient(ellipse at 45% 40%, #333333, #181818 70%);
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.05);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        width 0.4s ease, height 0.4s ease;
    }

    /* ===== PUPIL — capsule shape matching eyeball ===== */
    .pupil {
      position: absolute;
      width: 50%;
      height: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 100px;
      background: radial-gradient(ellipse at 45% 40%, #111111, #000000 70%);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      transition: width 0.4s ease, height 0.4s ease;
    }

    /* ===== EYELIDS — straight flat edges that can rotate ===== */
    .eyelid {
      position: absolute;
      left: -10%;
      width: 120%;
      height: 52%;
      background: #ffffff;
      z-index: 10;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      pointer-events: none;
      /* No border-radius — straight edge */
    }

    .eyelid-top {
      top: 0;
      transform: translateY(-100%);
      transform-origin: center bottom;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
    }

    .eyelid-bottom {
      bottom: 0;
      transform: translateY(100%);
      transform-origin: center top;
      box-shadow: 0 -3px 6px rgba(0, 0, 0, 0.08);
    }

    /* ===== EYELID STATES ===== */

    /* Happy squint — top comes down + slight inward angle */
    .eyelid-top.squint {
      transform: translateY(-55%) rotate(0deg);
    }

    .eyelid-bottom.squint {
      transform: translateY(55%) rotate(0deg);
    }

    /* Angry/determined — eyelids angle inward (left eye rotates one way, right the other) */
    .eye-socket.left-eye .eyelid-top.angry {
      transform: translateY(-55%) rotate(12deg);
    }

    .eye-socket.right-eye .eyelid-top.angry {
      transform: translateY(-55%) rotate(-12deg);
    }

    /* Thinking — eyelid droops straight down (no rotation) */
    .eyelid-top.droop-straight {
      transform: translateY(-55%) rotate(10deg);
    }

    /* Thinking — eyelid droops at angle */
    .eyelid-top.droop {
      transform: translateY(-70%) rotate(0deg);
    }

    /* Surprised — eyelids pull back fully */
    .eyelid-top.wide {
      transform: translateY(-100%) rotate(0deg);
    }

    .eyelid-bottom.wide {
      transform: translateY(100%) rotate(0deg);
    }

    /* Skeptical — one eyebrow raised (slight tilt) */
    .eyelid-top.raised {
      transform: translateY(-95%) rotate(-5deg);
    }


    /* ===== EYEBALL ANIMATIONS ===== */
    @keyframes scan-eyeball {
      0% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(20px);
      }

      40% {
        transform: translateX(20px);
      }

      60% {
        transform: translateX(-20px);
      }

      80% {
        transform: translateX(-20px);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes thinking-iris {

      0%,
      100% {
        transform: translate(-50%, -50%);
      }

      25% {
        transform: translate(calc(-50% + 8px), calc(-50% - 5px));
      }

      75% {
        transform: translate(calc(-50% - 5px), calc(-50% - 3px));
      }
    }


    .iris.thinking {
      animation: thinking-iris 2.5s ease-in-out infinite;
    }

    /* ===== SCANNING — iris/pupil move, eye sockets tilt to follow ===== */
    @keyframes scan-iris {
      0% {
        transform: translate(-50%, -50%);
      }

      15% {
        transform: translate(-50%, -50%) translateX(25px);
      }

      35% {
        transform: translate(-50%, -50%) translateX(25px);
      }

      50% {
        transform: translate(-50%, -50%);
      }

      65% {
        transform: translate(-50%, -50%) translateX(-25px);
      }

      85% {
        transform: translate(-50%, -50%) translateX(-25px);
      }

      100% {
        transform: translate(-50%, -50%);
      }
    }

    @keyframes scan-socket-left {
      0% {
        transform: rotate(0deg) scaleY(1);
      }

      15% {
        transform: rotate(-6deg) scaleY(0.92);
      }

      35% {
        transform: rotate(-6deg) scaleY(0.92);
      }

      50% {
        transform: rotate(0deg) scaleY(1);
      }

      65% {
        transform: rotate(6deg) scaleY(0.92);
      }

      85% {
        transform: rotate(6deg) scaleY(0.92);
      }

      100% {
        transform: rotate(0deg) scaleY(1);
      }
    }

    @keyframes scan-socket-right {
      0% {
        transform: rotate(0deg) scaleY(1);
      }

      15% {
        transform: rotate(-8deg) scaleY(0.88);
      }

      35% {
        transform: rotate(-8deg) scaleY(0.88);
      }

      50% {
        transform: rotate(0deg) scaleY(1);
      }

      65% {
        transform: rotate(8deg) scaleY(0.88);
      }

      85% {
        transform: rotate(8deg) scaleY(0.88);
      }

      100% {
        transform: rotate(0deg) scaleY(1);
      }
    }

    .iris.scanning {
      animation: scan-iris 3s ease-in-out infinite;
    }

    .eye-socket.left-eye.scanning {
      animation: scan-socket-left 3s ease-in-out infinite;
    }

    .eye-socket.right-eye.scanning {
      animation: scan-socket-right 3s ease-in-out infinite;
    }

    /* Scanning eyelid — slight squint */
    .eyelid-top.scan-squint {
      transform: translateY(-70%) rotate(0deg);
    }

    /* ===== EYELID HIDDEN (for happy) ===== */
    .eyelid-top.hidden-up {
      transform: translateY(-100%) rotate(0deg) !important;
    }

    /* Closed — LAST so it always overrides other states during blink */
    .eyelid-top.closed {
      transform: translateY(0%) rotate(0deg) !important;
    }

    .eyelid-bottom.closed {
      transform: translateY(0%) rotate(0deg) !important;
    }

    /* ===== STAR SPARKLE PARTICLES ===== */
    .star-particle {
      position: absolute;
      z-index: 5;
      pointer-events: none;
      opacity: 0;
    }

    .star-particle svg {
      width: 100%;
      height: 100%;
    }

    .star-particle svg path {
      fill: rgba(255, 255, 255, 0.9);
    }

    @keyframes sparkle {
      0% {
        opacity: 0;
        transform: scale(0) rotate(0deg);
      }

      20% {
        opacity: 1;
        transform: scale(1) rotate(20deg);
      }

      50% {
        opacity: 0.8;
        transform: scale(0.8) rotate(40deg);
      }

      80% {
        opacity: 1;
        transform: scale(1.1) rotate(60deg);
      }

      100% {
        opacity: 0;
        transform: scale(0) rotate(80deg);
      }
    }

    @keyframes sparkle-float {
      0% {
        opacity: 0;
        transform: scale(0) rotate(0deg) translateY(0);
      }

      30% {
        opacity: 1;
        transform: scale(1.2) rotate(30deg) translateY(-5px);
      }

      70% {
        opacity: 0.7;
        transform: scale(0.9) rotate(50deg) translateY(-10px);
      }

      100% {
        opacity: 0;
        transform: scale(0) rotate(90deg) translateY(-15px);
      }
    }

    .star-particle.sparkle-1 {
      animation: sparkle 1.5s ease-in-out infinite;
    }

    .star-particle.sparkle-2 {
      animation: sparkle-float 1.8s ease-in-out infinite 0.3s;
    }

    .star-particle.sparkle-3 {
      animation: sparkle 1.2s ease-in-out infinite 0.6s;
    }

    .star-particle.sparkle-4 {
      animation: sparkle-float 2s ease-in-out infinite 0.9s;
    }

    .star-particle.sparkle-5 {
      animation: sparkle 1.6s ease-in-out infinite 0.2s;
    }

    .star-particle.sparkle-6 {
      animation: sparkle-float 1.4s ease-in-out infinite 0.5s;
    }

    /* ===== WARNING / BATTERY LOW ===== */
    .battery-warning {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .battery-warning.active {
      opacity: 1;
      visibility: visible;
      animation: battery-blink 2.5s ease-in-out infinite;
    }

    .battery-warning svg {
      width: 200px;
      height: 200px;
      filter: drop-shadow(0 0 15px rgba(255, 30, 30, 0.8)) drop-shadow(0 0 40px rgba(255, 30, 30, 0.5)) drop-shadow(0 0 80px rgba(255, 0, 0, 0.3));
      animation: battery-glow 2.5s ease-in-out infinite;
    }

    .battery-warning svg .battery-body {
      fill: none;
      stroke: #ff1e1e;
      stroke-width: 2;
    }

    .battery-warning svg .battery-level {
      fill: #ff1e1e;
    }

    .battery-warning svg .battery-cap {
      fill: #ff1e1e;
    }

    .battery-warning-text {
      color: #ff1e1e;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 4px;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(255, 30, 30, 0.8),
        0 0 30px rgba(255, 30, 30, 0.4);
    }

    @keyframes battery-blink {
      0% {
        opacity: 1;
      }

      40% {
        opacity: 0.3;
      }

      60% {
        opacity: 0.3;
      }

      100% {
        opacity: 1;
      }
    }

    @keyframes battery-glow {

      0%,
      100% {
        filter: drop-shadow(0 0 12px rgba(255, 30, 30, 0.6)) drop-shadow(0 0 30px rgba(255, 30, 30, 0.35)) drop-shadow(0 0 60px rgba(255, 0, 0, 0.2));
      }

      50% {
        filter: drop-shadow(0 0 30px rgba(255, 30, 30, 1)) drop-shadow(0 0 70px rgba(255, 30, 30, 0.7)) drop-shadow(0 0 130px rgba(255, 0, 0, 0.5));
      }
    }

    .eye-socket.warning-glow {
      box-shadow:
        inset 0 0 20px rgba(255, 30, 30, 0.15),
        0 0 30px rgba(255, 30, 30, 0.2),
        0 0 60px rgba(255, 0, 0, 0.1);
    }

    /* ===== BREATHING ===== */
    @keyframes breathe {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.02);
      }
    }

    .face-container.breathing {
      animation: breathe 4s ease-in-out infinite;
    }

    .face-container {
      transition: transform 0.4s ease-in-out;
    }

    /* Smooth fade for eyes and mouth during warning */
    .eyes-container-wrap {
      transition: opacity 0.5s ease-in-out;
    }

    .eyes-container-wrap.fade-out {
      opacity: 0;
    }

    .mouth-container.fade-out {
      opacity: 0;
    }

    /* ===== MOUTH CONTAINER ===== */
    .mouth-container {
      position: relative;
      margin-top: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Outer mouth — visible border/lip shape */
    .mouth-outer {
      position: relative;
      width: 130px;
      height: 18px;
      border-radius: 100px;
      background: radial-gradient(ellipse at 50% 40%, #2a2a2a, #0a0a0a 80%);
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.2),
        inset 0 1px 3px rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Inner mouth — darker inset for depth */
    .mouth-inner {
      width: 70%;
      height: 55%;
      border-radius: 100px;
      background: radial-gradient(ellipse at 50% 40%, #1a1a1a, #000000 70%);
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Core — deepest layer, subtle highlight */
    .mouth-core {
      width: 50%;
      height: 40%;
      border-radius: 100px;
      background: #000000;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* ===== SMILE STATE — closed mouth, curved lip line ===== */
    .mouth-container.smile .mouth-outer {
      /* Curved smile arc — closed mouth */
      width: 140px;
      height: 18px;
      border-radius: 0 0 50% 50% / 0 0 100% 100%;
      background: linear-gradient(to bottom,
          #2a2a2a 0%,
          #1a1a1a 50%,
          #0a0a0a 100%);
      box-shadow:
        0 3px 8px rgba(0, 0, 0, 0.25),
        inset 0 1px 2px rgba(255, 255, 255, 0.04),
        inset 0 -1px 3px rgba(0, 0, 0, 0.5);
    }

    .mouth-container.smile .mouth-inner,
    .mouth-container.smile .mouth-core {
      display: none;
    }

    /* ===== HAPPY SMILE — wider, more open ===== */
    .mouth-container.happy-smile .mouth-outer {
      width: 160px;
      height: 80px;
      border-radius: 8% 8% 50% 50% / 0% 0% 100% 100%;
      background: radial-gradient(ellipse at 50% 25%, #2a2a2a, #0a0a0a 80%);
      box-shadow:
        0 6px 14px rgba(0, 0, 0, 0.35),
        inset 0 -4px 10px rgba(0, 0, 0, 0.45),
        inset 0 2px 5px rgba(255, 255, 255, 0.03);
    }

    .mouth-container.happy-smile .mouth-inner {
      width: 80%;
      height: 78%;
      border-radius: 6% 6% 50% 50% / 0% 0% 100% 100%;
      background: radial-gradient(ellipse at 50% 15%, #1a1a1a, #000000 70%);
      box-shadow: inset 0 -4px 12px rgba(0, 0, 0, 0.6);
      margin-top: 5%;
    }

    .mouth-container.happy-smile .mouth-core {
      width: 62%;
      height: 60%;
      border-radius: 4% 4% 50% 50% / 0% 0% 100% 100%;
      background: #000000;
      margin-top: 8%;
    }

    /* ===== THINK — small neutral pursed, like reference "Think" ===== */
    .mouth-container.think .mouth-outer {
      width: 50px;
      height: 14px;
    }

    .mouth-container.think .mouth-inner {
      width: 60%;
      height: 45%;
    }

    .mouth-container.think .mouth-core {
      width: 40%;
      height: 30%;
    }

    /* ===== SURPRISED O — round "Oh!" from reference ===== */
    .mouth-container.surprised .mouth-outer {
      width: 55px;
      height: 55px;
      border-radius: 50%;
    }

    .mouth-container.surprised .mouth-inner {
      width: 65%;
      height: 65%;
      border-radius: 50%;
    }

    .mouth-container.surprised .mouth-core {
      width: 55%;
      height: 55%;
      border-radius: 50%;
    }

    /* ===== TALKING VOWEL SHAPES ===== */
    .mouth-container.talking .mouth-outer,
    .mouth-container.talking .mouth-inner,
    .mouth-container.talking .mouth-core {
      transition: all 0.18s ease-in-out;
    }

    /* A — wide open, tall (like reference "A,E,I" / "aaa") */
    .mouth-container.vowel-a .mouth-outer {
      width: 80px;
      height: 50px;
      border-radius: 40%;
    }

    .mouth-container.vowel-a .mouth-inner {
      width: 70%;
      height: 65%;
      border-radius: 40%;
    }

    .mouth-container.vowel-a .mouth-core {
      width: 55%;
      height: 55%;
      border-radius: 40%;
    }

    /* E — wide horizontal, short (like reference "E,e") */
    .mouth-container.vowel-e .mouth-outer {
      width: 110px;
      height: 28px;
    }

    .mouth-container.vowel-e .mouth-inner {
      width: 75%;
      height: 55%;
    }

    .mouth-container.vowel-e .mouth-core {
      width: 55%;
      height: 40%;
    }

    /* I — very wide, thin (like reference "R" / wide grin) */
    .mouth-container.vowel-i .mouth-outer {
      width: 120px;
      height: 20px;
    }

    .mouth-container.vowel-i .mouth-inner {
      width: 70%;
      height: 50%;
    }

    .mouth-container.vowel-i .mouth-core {
      width: 50%;
      height: 35%;
    }

    /* O — round circle (like reference "O" / "Oh") */
    .mouth-container.vowel-o .mouth-outer {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }

    .mouth-container.vowel-o .mouth-inner {
      width: 65%;
      height: 65%;
      border-radius: 50%;
    }

    .mouth-container.vowel-o .mouth-core {
      width: 50%;
      height: 50%;
      border-radius: 50%;
    }

    /* U — small round (like reference "Un" / puckered) */
    .mouth-container.vowel-u .mouth-outer {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }

    .mouth-container.vowel-u .mouth-inner {
      width: 60%;
      height: 60%;
      border-radius: 50%;
    }

    .mouth-container.vowel-u .mouth-core {
      width: 45%;
      height: 45%;
      border-radius: 50%;
    }
  </style>
</head>

<body class="bg-white h-screen flex items-center justify-center">

  <!-- Main Face Container -->
  <div id="faceContainer"
    class="face-container breathing relative w-full h-full flex flex-col items-center justify-center">

    <!-- Eyes Container -->
    <div class="eyes-container-wrap flex items-center justify-center gap-64">

      <!-- Left Eye -->
      <div id="leftEye" class="eye-socket left-eye">
        <div class="eyelid eyelid-top" id="leftEyelidTop"></div>
        <div class="eyeball" id="leftEyeball">
          <div class="iris" id="leftIris">
            <div class="pupil" id="leftPupil"></div>
          </div>
        </div>
        <div class="eyelid eyelid-bottom" id="leftEyelidBottom"></div>
      </div>

      <!-- Right Eye -->
      <div id="rightEye" class="eye-socket right-eye">
        <div class="eyelid eyelid-top" id="rightEyelidTop"></div>
        <div class="eyeball" id="rightEyeball">
          <div class="iris" id="rightIris">
            <div class="pupil" id="rightPupil"></div>
          </div>
        </div>
        <div class="eyelid eyelid-bottom" id="rightEyelidBottom"></div>
      </div>

    </div>

    <!-- Battery Warning Overlay -->
    <div id="batteryWarning" class="battery-warning">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <!-- Battery body -->
        <rect class="battery-body" x="12" y="16" width="36" height="32" rx="4" ry="4" />
        <!-- Battery cap (positive terminal) -->
        <rect class="battery-cap" x="48" y="26" width="6" height="12" rx="2" ry="2" />
        <!-- Low charge level bar -->
        <rect class="battery-level" x="16" y="34" width="8" height="10" rx="1" ry="1" />
      </svg>
      <span class="battery-warning-text">LOW BATTERY</span>
    </div>

    <!-- Mouth -->
    <div id="mouthContainer" class="mouth-container">
      <div id="mouthOuter" class="mouth-outer">
        <div id="mouthInner" class="mouth-inner">
          <div id="mouthCore" class="mouth-core"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const CONFIG = {
      timings: {
        blinkDuration: 300,
        minBlinkDelay: 3000,
        maxBlinkDelay: 7000,
        talkUpdateSpeed: 200,
        transitions: {
          default: 'all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
          talking: 'all 0.15s cubic-bezier(0.5, 0, 0.5, 1.5)'
        }
      },
      sizes: {
        mouth: {
          default: { w: '130px', h: '18px' },
          minWidth: 50,
          maxWidth: 150,
          minHeight: 14,
          maxHeight: 70
        }
      }
    };

    // ==========================================
    // STATE MANAGEMENT
    // ==========================================
    const State = {
      currentExpression: 'idle',
      intervals: {
        talking: null,
        blink: null
      }
    };

    // ==========================================
    // UI ELEMENTS
    // ==========================================
    const UI = {
      // Eye sockets
      leftEye: document.getElementById('leftEye'),
      rightEye: document.getElementById('rightEye'),
      // Eyelids
      leftEyelidTop: document.getElementById('leftEyelidTop'),
      leftEyelidBottom: document.getElementById('leftEyelidBottom'),
      rightEyelidTop: document.getElementById('rightEyelidTop'),
      rightEyelidBottom: document.getElementById('rightEyelidBottom'),
      // Eyeballs
      leftEyeball: document.getElementById('leftEyeball'),
      rightEyeball: document.getElementById('rightEyeball'),
      // Irises
      leftIris: document.getElementById('leftIris'),
      rightIris: document.getElementById('rightIris'),
      // Mouth
      mouthContainer: document.getElementById('mouthContainer'),
      mouthOuter: document.getElementById('mouthOuter'),
      mouthInner: document.getElementById('mouthInner'),
      mouthCore: document.getElementById('mouthCore'),
      // Face
      faceContainer: document.getElementById('faceContainer')
    };

    // Helper: get all eyelid tops/bottoms
    const allEyelidTops = [UI.leftEyelidTop, UI.rightEyelidTop];
    const allEyelidBottoms = [UI.leftEyelidBottom, UI.rightEyelidBottom];
    const allEyelids = [...allEyelidTops, ...allEyelidBottoms];
    const allEyeballs = [UI.leftEyeball, UI.rightEyeball];
    const allIrises = [UI.leftIris, UI.rightIris];

    // ==========================================
    // CONTROLLERS
    // ==========================================

    const MouthController = {
      vowels: ['vowel-a', 'vowel-e', 'vowel-i', 'vowel-o', 'vowel-u'],
      allStates: ['smile', 'happy-smile', 'think', 'surprised', 'talking',
        'vowel-a', 'vowel-e', 'vowel-i', 'vowel-o', 'vowel-u'],
      currentVowel: null,

      setVowel() {
        // Pick a random vowel different from current
        let next;
        do {
          next = this.vowels[Math.floor(Math.random() * this.vowels.length)];
        } while (next === this.currentVowel && this.vowels.length > 1);

        // Remove old vowel, add new
        if (this.currentVowel) UI.mouthContainer.classList.remove(this.currentVowel);
        UI.mouthContainer.classList.add(next);
        this.currentVowel = next;
      },

      startTalking() {
        if (State.intervals.talking) return;
        UI.mouthContainer.classList.add('talking');
        this.setVowel();
        State.intervals.talking = setInterval(() => this.setVowel(), CONFIG.timings.talkUpdateSpeed);
      },

      stopTalking() {
        if (State.intervals.talking) {
          clearInterval(State.intervals.talking);
          State.intervals.talking = null;
        }
        UI.mouthContainer.classList.remove('talking');
        if (this.currentVowel) {
          UI.mouthContainer.classList.remove(this.currentVowel);
          this.currentVowel = null;
        }
      },

      reset() {
        this.stopTalking();
        // Remove all mouth shape states
        this.allStates.forEach(s => UI.mouthContainer.classList.remove(s));
        // Reset inline styles
        UI.mouthOuter.style.width = '';
        UI.mouthOuter.style.height = '';
      },

      setSmile() {
        UI.mouthContainer.classList.add('smile');
      },

      setHappySmile() {
        UI.mouthContainer.classList.add('happy-smile');
      },

      setThink() {
        UI.mouthContainer.classList.add('think');
      },

      setSurprised() {
        UI.mouthContainer.classList.add('surprised');
      },

      setWarning() {
        // Flat worried mouth — wider than think, flat line
        UI.mouthContainer.classList.add('think');
      }
    };

    const EyeController = {
      // Reset all eyelid and eyeball states
      resetAll() {
        // Clear eyelid states
        const lidStates = ['closed', 'squint', 'droop', 'droop-straight', 'wide', 'happy-anim', 'hidden-up', 'scan-squint'];
        allEyelids.forEach(lid => {
          lidStates.forEach(s => lid.classList.remove(s));
        });

        // Clear warning glow
        [UI.leftEye, UI.rightEye].forEach(eye => {
          eye.classList.remove('warning-glow');
        });

        // Hide battery warning
        WarningController.hide();

        // Clear eyeball states
        allEyeballs.forEach(eb => {
          eb.style.transform = '';
        });

        // Clear iris animations
        allIrises.forEach(iris => {
          iris.classList.remove('scanning', 'thinking');
        });

        // Clear eye socket scanning
        [UI.leftEye, UI.rightEye].forEach(eye => {
          eye.classList.remove('scanning');
          eye.style.transform = '';
        });


        // Reset iris
        allIrises.forEach(iris => {
          iris.style.transform = 'translate(-50%, -50%)';
          iris.style.width = '';
          iris.style.height = '';
        });

        // Remove star particles
        document.querySelectorAll('.star-particle').forEach(s => s.remove());
      },

      // Blink via eyelids
      blink() {
        // Close eyelids
        allEyelidTops.forEach(lid => lid.classList.add('closed'));
        allEyelidBottoms.forEach(lid => lid.classList.add('closed'));

        setTimeout(() => {
          allEyelidTops.forEach(lid => lid.classList.remove('closed'));
          allEyelidBottoms.forEach(lid => lid.classList.remove('closed'));
        }, CONFIG.timings.blinkDuration);
      },

      startRandomBlinking() {
        const { minBlinkDelay, maxBlinkDelay } = CONFIG.timings;
        const delay = Math.random() * (maxBlinkDelay - minBlinkDelay) + minBlinkDelay;

        setTimeout(() => {
          if (!['thinking', 'scanning'].includes(State.currentExpression)) {
            this.blink();
          }
          this.startRandomBlinking();
        }, delay);
      },

      // Expression-specific eye setups
      setIdle() {
        // Eyelids at default open position — already reset
      },

      setHappy() {
        // Hide top eyelids completely
        allEyelidTops.forEach(lid => {
          lid.classList.add('hidden-up');
        });
        // Bottom eyelids squint up
        allEyelidBottoms.forEach(lid => lid.classList.add('squint'));
        // Add sparkle stars to each eyeball
        this.addStarParticles();
      },

      addStarParticles() {
        const starSVG = `<svg viewBox="0 0 24 24"><path d="M12 0l3.09 6.26L22 7.27l-5 4.87L18.18 19 12 15.77 5.82 19 7 12.14l-5-4.87 6.91-1.01z"/></svg>`;
        const positions = [
          { top: '12%', left: '15%', size: 18, cls: 'sparkle-1' },
          { top: '25%', left: '65%', size: 14, cls: 'sparkle-2' },
          { top: '55%', left: '20%', size: 11, cls: 'sparkle-3' },
          { top: '60%', left: '70%', size: 16, cls: 'sparkle-4' },
          { top: '35%', left: '40%', size: 10, cls: 'sparkle-5' },
          { top: '75%', left: '50%', size: 13, cls: 'sparkle-6' },
        ];

        allEyeballs.forEach(eyeball => {
          positions.forEach(p => {
            const star = document.createElement('div');
            star.className = `star-particle ${p.cls}`;
            star.style.top = p.top;
            star.style.left = p.left;
            star.style.width = `${p.size}px`;
            star.style.height = `${p.size}px`;
            star.innerHTML = starSVG;
            eyeball.appendChild(star);
          });
        });
      },

      setThinking() {
        // Iris/pupil drift slightly (eyeball stays fixed)
        allIrises.forEach(iris => iris.classList.add('thinking'));
        // Left eyelid droops straight, right eyelid droops with angle
        UI.leftEyelidTop.classList.add('droop-straight');
        UI.rightEyelidTop.classList.add('droop');
      },

      setScanning() {
        // Iris/pupil scan left-right
        allIrises.forEach(iris => iris.classList.add('scanning'));
        // Eye sockets tilt to follow scan direction
        UI.leftEye.classList.add('scanning');
        UI.rightEye.classList.add('scanning');
        // Slight eyelid squint for focus
        allEyelidTops.forEach(lid => lid.classList.add('scan-squint'));
      },



      setTalking() {
        // Eyes stay open and attentive, slight iris expansion
        allIrises.forEach(iris => {
          iris.style.width = '60%';
          iris.style.height = '60%';
        });
      },

      setSurprised() {
        // Eyelids pull back fully, iris expands
        allEyelidTops.forEach(lid => lid.classList.add('wide'));
        allEyelidBottoms.forEach(lid => lid.classList.add('wide'));
        allIrises.forEach(iris => {
          iris.style.width = '75%';
          iris.style.height = '75%';
        });
      },

      setWarning() {
        // Slightly narrowed lids — alert look
        allEyelidTops.forEach(lid => lid.classList.add('droop-straight'));
        // Red glow on eye sockets
        [UI.leftEye, UI.rightEye].forEach(eye => {
          eye.classList.add('warning-glow');
        });
      },

      // Head-tracking eye movement
      _eyeReturnTimeout: null,
      moveByDirection(direction) {
        // Cancel any pending return-to-center
        if (this._eyeReturnTimeout) {
          clearTimeout(this._eyeReturnTimeout);
          this._eyeReturnTimeout = null;
        }

        const offset = 25; // pixels to shift
        const dirMap = {
          up: { x: 0, y: -offset },
          down: { x: 0, y: offset },
          left: { x: -offset, y: 0 },
          right: { x: offset, y: 0 },
          'up-left': { x: -offset, y: -offset },
          'up-right': { x: offset, y: -offset },
          'down-left': { x: -offset, y: offset },
          'down-right': { x: offset, y: offset }
        };

        if (direction === 'center' || !dirMap[direction]) {
          // Return eyes to center after a short delay (simulates settling)
          this._eyeReturnTimeout = setTimeout(() => {
            allIrises.forEach(iris => {
              iris.style.transform = 'translate(-50%, -50%)';
            });
            this._eyeReturnTimeout = null;
          }, 400);
          return;
        }

        const { x, y } = dirMap[direction];
        allIrises.forEach(iris => {
          iris.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        });
      }
    };

    // ==========================================
    // WARNING / BATTERY CONTROLLER
    // ==========================================
    const WarningController = {
      el: document.getElementById('batteryWarning'),
      eyesWrap: document.querySelector('.eyes-container-wrap'),
      _showTimeout: null,
      _hideTimeout: null,

      show() {
        // Cancel any pending hide restoration
        if (this._hideTimeout) {
          clearTimeout(this._hideTimeout);
          this._hideTimeout = null;
        }
        // Fade out eyes and mouth first
        this.eyesWrap.classList.add('fade-out');
        UI.mouthContainer.classList.add('fade-out');
        // Then show battery icon after fade completes
        this._showTimeout = setTimeout(() => {
          this.el.classList.add('active');
          this._showTimeout = null;
        }, 500);
      },

      hide() {
        // Cancel any pending show
        if (this._showTimeout) {
          clearTimeout(this._showTimeout);
          this._showTimeout = null;
        }
        this.el.classList.remove('active');
        // Fade eyes and mouth back in after battery fades out
        this._hideTimeout = setTimeout(() => {
          this.eyesWrap.classList.remove('fade-out');
          UI.mouthContainer.classList.remove('fade-out');
          this._hideTimeout = null;
        }, 400);
      }
    };

    // ==========================================
    // MAIN ROBOT CONTROLLER
    // ==========================================
    const RobotFace = {
      init() {
        this.setExpression('idle');
        EyeController.startRandomBlinking();
        this.exposeAPI();
        console.log('BayMax Face UI Initialized');
        console.log('Available expressions: idle, happy, thinking, scanning, talking, surprised, warning');
      },

      setExpression(expression) {
        // Reset everything first
        EyeController.resetAll();
        UI.faceContainer.className = 'face-container breathing relative w-full h-full flex flex-col items-center justify-center';

        State.currentExpression = expression;

        // Reset mouth state
        MouthController.reset();

        // Handle Mouth State
        if (expression === 'talking') {
          MouthController.startTalking();
        }

        // Apply Expression Logic
        switch (expression) {
          case 'idle':
            EyeController.setIdle();
            MouthController.setSmile();
            break;

          case 'happy':
            EyeController.setHappy();
            MouthController.setHappySmile();
            break;

          case 'thinking':
            EyeController.setThinking();
            MouthController.setThink();
            break;


          case 'scanning':
            EyeController.setScanning();
            break;

          case 'talking':
            EyeController.setTalking();
            break;

          case 'surprised':
            EyeController.setSurprised();
            MouthController.setSurprised();
            break;

          case 'warning':
            EyeController.setWarning();
            MouthController.setWarning();
            WarningController.show();
            break;
        }
      },

      exposeAPI() {
        window.robotFace = {
          setExpression: (expr) => this.setExpression(expr),
          blink: () => EyeController.blink(),
          moveEyes: (dir) => EyeController.moveByDirection(dir),
          setStatus: (text) => console.log('Status: ' + text)
        };

        window.setExpression = (expr) => this.setExpression(expr);
        window.blink = () => EyeController.blink();
        window.moveEyes = (dir) => EyeController.moveByDirection(dir);
      }
    };

    // Start Controller
    RobotFace.init();
  </script>
</body>

</html>